<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÊóÖ„ÅÆÊÄù„ÅÑÂá∫„Ç¢„É´„Éê„É†</title>
    <style>
        /* ‰∫¨ÈÉΩ„ÉªÊªãË≥Ä„ÉÜ„Éº„Éû */
        :root {
            --primary-color: #ed6d3d;
            --bg-color: #fdfcf8;
            --text-color: #4a3b32;
            --overlay-color: rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 140px; 
        }

        header {
            text-align: center;
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 50;
            /* „Éõ„Éº„É†„Éú„Çø„É≥Áî®„Å´ËøΩÂä† */
            position: sticky; 
        }
        
        h1 {
            margin: 0;
            font-size: 20px;
        }

       /* üè† „Éõ„Éº„É†„Éú„Çø„É≥ÔºàÁîªÂÉèÁâàÔºâ */
        .home-btn {
            position: absolute;
            left: 20px;      /* Â∑¶Á´Ø„Åã„Çâ„ÅÆË∑ùÈõ¢ */
            top: 50%;
            transform: translateY(-50%); /* ‰∏ä‰∏ã„ÅÆÁúü„Çì‰∏≠ */
            
            width: 28px;     /* „Ç¢„Ç§„Ç≥„É≥„ÅÆÂ§ß„Åç„Åï */
            height: 28px;
            
            display: block;
            transition: transform 0.1s;
        }
        
        /* ÁîªÂÉè„ÅÆËâ≤„ÇíÁôΩ„Åè„Åô„ÇãË®≠ÂÆö */
        .home-btn img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .home-btn:active {
            transform: translateY(-50%) scale(0.9);
        }

        /* „Çø„Ç§„É†„É©„Ç§„É≥„Ç®„É™„Ç¢ */
        .timeline {
            position: relative;
            margin: 20px;
            margin-left: 30px;
            border-left: 3px solid var(--primary-color);
            padding-left: 20px;
            min-height: 200px;
        }

        .memory-item {
            position: relative;
            margin-bottom: 40px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .memory-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 15px;
            width: 15px;
            height: 15px;
            background-color: white;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .time {
            font-family: sans-serif;
            font-weight: bold;
            color: var(--primary-color);
            font-size: 16px;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            color: #ccc;
            transition: color 0.2s;
        }
        .edit-btn:hover { color: #007bff; }
        .delete-btn:hover { color: #ff4d4d; }

        .photo {
            width: 100%;
            border-radius: 5px;
            margin: 5px 0 10px;
            display: block;
            object-fit: cover;
        }

        .comment {
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }

        .post-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 10px 15px 15px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            z-index: 100;
            display: flex;
            flex-direction: column; 
            gap: 10px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        #dateInput {
            font-size: 14px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #f9f9f9;
            width: 100%;
            font-family: sans-serif;
        }

        #fileInput { display: none; }
        .camera-icon {
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        #commentInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
        }

        #sendBtn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-color);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            width: 85%;
            max-width: 400px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: left;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-group {
            margin-bottom: 15px;
        }
        .modal-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .modal-preview-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-save { background-color: var(--primary-color); color: white; }
        .modal-cancel { background-color: #ccc; color: #333; }

    </style>
</head>
<body>

    <header>
       <a href="index.html" class="home-btn">
            <img src="images/home.png" alt="„Éõ„Éº„É†">
        </a>
        <h1>üì∏ ÊóÖ„ÅÆÊÄù„ÅÑÂá∫„Ç¢„É´„Éê„É†</h1>
    </header>

    <div class="timeline" id="memoryList"></div>

    <a href="index.html" class="back-link">Ôºú Ë°®Á¥ô„Å´Êàª„Çã</a>

    <div class="post-area">
        <input type="datetime-local" id="dateInput">
        <div class="input-row">
            <label for="fileInput" class="camera-icon">üì∑</label>
            <input type="file" id="fileInput" accept="image/*">
            <input type="text" id="commentInput" placeholder="ÊÄù„ÅÑÂá∫„Çí‰∏ÄË®Ä...">
            <button id="sendBtn" onclick="addMemory()">‰øùÂ≠ò</button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>ÊÄù„ÅÑÂá∫„ÇíÁ∑®ÈõÜ</h2>
            <input type="hidden" id="editId">
            <div class="modal-group">
                <label>Êó•ÊôÇ</label>
                <input type="datetime-local" id="editDateInput" style="width: 100%; padding: 8px; box-sizing: border-box;">
            </div>
            <div class="modal-group">
                <label>ÂÜôÁúü (Â§âÊõ¥„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøÈÅ∏Êäû)</label>
                <img id="editPreview" class="modal-preview-img">
                <input type="file" id="editFileInput" accept="image/*">
            </div>
            <div class="modal-group">
                <label>„Ç≥„É°„É≥„Éà</label>
                <input type="text" id="editCommentInput" style="width: 100%; padding: 8px; box-sizing: border-box;">
            </div>
            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" onclick="closeModal()">„Ç≠„É£„É≥„Çª„É´</button>
                <button class="modal-btn modal-save" onclick="saveEdit()">Êõ¥Êñ∞</button>
            </div>
        </div>
    </div>

    <script>
        const DB_NAME = 'TravelShioriDB';
        const DB_VERSION = 1;
        const STORE_NAME = 'memories';
        let db;

        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('dateInput').value = getNowForInput();
            try {
                await initDB();
                loadMemories();
            } catch (e) {
                console.error("DB Error:", e);
            }
        });

        document.getElementById('fileInput').addEventListener('change', function() {
            const btn = document.querySelector('.camera-icon');
            if (this.files && this.files[0]) {
                btn.style.backgroundColor = '#ed6d3d';
                btn.style.color = 'white';
            }
        });

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                    }
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onerror = (event) => {
                    reject(event.target.error);
                };
            });
        }

        function saveToDB(item) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.put(item); 
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function deleteFromDB(id) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.delete(id); 
                request.onsuccess = () => resolve();
                request.onerror = (e) => reject(e.target.error);
            });
        }

        function getAllFromDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result);
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function addMemory() {
            const dateInput = document.getElementById('dateInput');
            const fileInput = document.getElementById('fileInput');
            const commentInput = document.getElementById('commentInput');
            
            const file = fileInput.files[0];
            const comment = commentInput.value;
            const dateVal = dateInput.value;

            if (!file && !comment) {
                alert("ÂÜôÁúü„Åã„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                return;
            }
            if (!dateVal) {
                alert("Êó•ÊôÇ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                return;
            }

            let imageData = null;
            if (file) {
                try {
                    imageData = await compressImage(file);
                } catch (e) {
                    alert("ÁîªÂÉè„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                    return;
                }
            }

            const newMemory = {
                id: Date.now(),
                timestamp: dateVal,
                image: imageData,
                comment: comment
            };

            try {
                await saveToDB(newMemory);
                loadMemories();
            } catch (e) {
                alert("‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            }

            fileInput.value = "";
            commentInput.value = "";
            dateInput.value = getNowForInput();
            document.querySelector('.camera-icon').style.backgroundColor = 'transparent';
            document.querySelector('.camera-icon').style.color = '#ed6d3d';
        }

        async function loadMemories() {
            try {
                let memories = await getAllFromDB();
                memories.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                renderMemories(memories);
            } catch (e) {
                console.error("Load Error:", e);
            }
        }

        function renderMemories(memories) {
            const list = document.getElementById('memoryList');
            list.innerHTML = "";

            memories.forEach(item => {
                const div = document.createElement('div');
                div.className = 'memory-item';

                const dateObj = new Date(item.timestamp);
                const dateStr = `${dateObj.getMonth() + 1}/${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}`;

                let html = `
                    <div class="item-header">
                        <div class="time">${dateStr}</div>
                        <div class="actions">
                            <button class="action-btn edit-btn" onclick="openEditModal(${item.id})">‚úèÔ∏è</button>
                            <button class="action-btn delete-btn" onclick="deleteMemory(${item.id})">√ó</button>
                        </div>
                    </div>
                `;

                if (item.image) {
                    html += `<img src="${item.image}" class="photo">`;
                }
                if (item.comment) {
                    html += `<div class="comment">${escapeHtml(item.comment)}</div>`;
                }

                div.innerHTML = html;
                list.appendChild(div);
            });
        }

        async function openEditModal(id) {
            const memories = await getAllFromDB();
            const item = memories.find(m => m.id === id);
            if (!item) return;

            document.getElementById('editId').value = item.id;
            document.getElementById('editDateInput').value = item.timestamp;
            document.getElementById('editCommentInput').value = item.comment;
            
            const preview = document.getElementById('editPreview');
            if (item.image) {
                preview.src = item.image;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
            
            document.getElementById('editFileInput').value = "";
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        async function saveEdit() {
            const id = Number(document.getElementById('editId').value);
            const dateVal = document.getElementById('editDateInput').value;
            const commentVal = document.getElementById('editCommentInput').value;
            const fileInput = document.getElementById('editFileInput');

            if (!dateVal) {
                alert("Êó•ÊôÇ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");
                return;
            }

            const memories = await getAllFromDB();
            const originalItem = memories.find(m => m.id === id);
            if (!originalItem) return;

            let newImage = originalItem.image;
            if (fileInput.files && fileInput.files[0]) {
                try {
                    newImage = await compressImage(fileInput.files[0]);
                } catch (e) {
                    alert("ÁîªÂÉè„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
                    return;
                }
            }

            const updatedItem = {
                id: id,
                timestamp: dateVal,
                image: newImage,
                comment: commentVal
            };

            try {
                await saveToDB(updatedItem);
                loadMemories();
                closeModal();
            } catch (e) {
                alert("Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            }
        }

        async function deleteMemory(id) {
            if (!confirm("Êú¨ÂΩì„Å´ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
            try {
                await deleteFromDB(id);
                loadMemories();
            } catch (e) {
                alert("ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü");
            }
        }

        function getNowForInput() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            return now.toISOString().slice(0, 16);
        }

        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 800;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function escapeHtml(str) {
            if(!str) return "";
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[match];
            });
        }
    </script>
</body>
</html>