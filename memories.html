<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—…ã®æ€ã„å‡ºã‚¢ãƒ«ãƒãƒ </title>
    <style>
        /* äº¬éƒ½ãƒ»æ»‹è³€ãƒ†ãƒ¼ãƒ */
        :root {
            --primary-color: #ed6d3d;
            --bg-color: #fdfcf8;
            --text-color: #4a3b32;
            --overlay-color: rgba(0, 0, 0, 0.6);
        }

        body {
            font-family: "Hiragino Mincho ProN", "Yu Mincho", serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            padding-bottom: 140px; /* å…¥åŠ›ã‚¨ãƒªã‚¢ã®åˆ†ã ã‘ä½™ç™½ */
        }

        header {
            text-align: center;
            padding: 20px;
            background-color: var(--primary-color);
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        h1 {
            margin: 0;
            font-size: 20px;
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¨ãƒªã‚¢ */
        .timeline {
            position: relative;
            margin: 20px;
            margin-left: 30px;
            border-left: 3px solid var(--primary-color);
            padding-left: 20px;
        }

        .memory-item {
            position: relative;
            margin-bottom: 40px;
            background: white;
            border-radius: 10px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ä¸¸ */
        .memory-item::before {
            content: '';
            position: absolute;
            left: -29px;
            top: 15px;
            width: 15px;
            height: 15px;
            background-color: white;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ†ï¼ˆæ—¥æ™‚ãƒ»æ“ä½œãƒœã‚¿ãƒ³ï¼‰ */
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
        }

        .time {
            font-family: sans-serif;
            font-weight: bold;
            color: var(--primary-color);
            font-size: 16px;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            padding: 0;
            color: #ccc;
            transition: color 0.2s;
        }
        .edit-btn:hover { color: #007bff; }
        .delete-btn:hover { color: #ff4d4d; }

        .photo {
            width: 100%;
            border-radius: 5px;
            margin: 5px 0 10px;
            display: block;
            object-fit: cover;
        }

        .comment {
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-bottom: 20px;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: bold;
        }

        /* --- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆç”»é¢ä¸‹éƒ¨å›ºå®šï¼‰ --- */
        .post-area {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            padding: 10px 15px 15px; /* ä¸Šãƒ»æ¨ªãƒ»ä¸‹ */
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            box-sizing: border-box;
            z-index: 100;
            display: flex;
            flex-direction: column; /* ç¸¦ä¸¦ã³ã«å¤‰æ›´ï¼ˆæ—¥ä»˜æ¬„ã‚’å…¥ã‚Œã‚‹ãŸã‚ï¼‰ */
            gap: 10px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            width: 100%;
        }

        /* æ—¥ä»˜å…¥åŠ›æ¬„ */
        #dateInput {
            font-size: 14px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background: #f9f9f9;
            width: 100%;
            font-family: sans-serif;
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ï¼ˆã‚«ãƒ¡ãƒ©ï¼‰ */
        #fileInput { display: none; }
        .camera-icon {
            font-size: 24px;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; /* ç¸®ã¾ãªã„ã‚ˆã†ã« */
        }

        #commentInput {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 20px;
            font-size: 16px;
            outline: none;
        }

        #sendBtn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
        }

        /* --- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼‰ --- */
        .modal {
            display: none; /* æœ€åˆã¯éš ã™ */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--overlay-color);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            width: 85%;
            max-width: 400px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: left;
        }

        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-group {
            margin-bottom: 15px;
        }
        .modal-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 14px;
        }
        
        .modal-preview-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-save { background-color: var(--primary-color); color: white; }
        .modal-cancel { background-color: #ccc; color: #333; }

    </style>
</head>
<body>

    <header>
        <h1>ğŸ“¸ æ—…ã®æ€ã„å‡ºã‚¢ãƒ«ãƒãƒ </h1>
    </header>

    <div class="timeline" id="memoryList">
        </div>

    <a href="index.html" class="back-link">ï¼œ è¡¨ç´™ã«æˆ»ã‚‹</a>

    <div class="post-area">
        <input type="datetime-local" id="dateInput">

        <div class="input-row">
            <label for="fileInput" class="camera-icon">ğŸ“·</label>
            <input type="file" id="fileInput" accept="image/*">

            <input type="text" id="commentInput" placeholder="æ€ã„å‡ºã‚’ä¸€è¨€...">

            <button id="sendBtn" onclick="addMemory()">ä¿å­˜</button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>æ€ã„å‡ºã‚’ç·¨é›†</h2>
            
            <input type="hidden" id="editId">

            <div class="modal-group">
                <label>æ—¥æ™‚</label>
                <input type="datetime-local" id="editDateInput" style="width: 100%; padding: 8px; box-sizing: border-box;">
            </div>

            <div class="modal-group">
                <label>å†™çœŸ (å¤‰æ›´ã™ã‚‹å ´åˆã®ã¿é¸æŠ)</label>
                <img id="editPreview" class="modal-preview-img">
                <input type="file" id="editFileInput" accept="image/*">
            </div>

            <div class="modal-group">
                <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
                <input type="text" id="editCommentInput" style="width: 100%; padding: 8px; box-sizing: border-box;">
            </div>

            <div class="modal-buttons">
                <button class="modal-btn modal-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="modal-btn modal-save" onclick="saveEdit()">æ›´æ–°</button>
            </div>
        </div>
    </div>

    <script>
        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å¤‰ãˆã¦ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿ã¨ã®ç«¶åˆå›é¿ï¼‰
        const STORAGE_KEY = 'travel_memories_v2';

        document.addEventListener('DOMContentLoaded', () => {
            // æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã®æ—¥ä»˜æ¬„ã«ã€åˆæœŸå€¤ã¨ã—ã¦ã€Œç¾åœ¨æ™‚åˆ»ã€ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('dateInput').value = getNowForInput();
            
            loadMemories();
        });

        // ã‚«ãƒ¡ãƒ©ã‚¢ã‚¤ã‚³ãƒ³ã®è‰²å¤‰åŒ–ï¼ˆé¸æŠæ™‚ï¼‰
        document.getElementById('fileInput').addEventListener('change', function() {
            const btn = document.querySelector('.camera-icon');
            if (this.files && this.files[0]) {
                btn.style.backgroundColor = '#ed6d3d';
                btn.style.color = 'white';
            }
        });

        // --- 1. æŠ•ç¨¿æ©Ÿèƒ½ ---
        async function addMemory() {
            const dateInput = document.getElementById('dateInput');
            const fileInput = document.getElementById('fileInput');
            const commentInput = document.getElementById('commentInput');
            
            const file = fileInput.files[0];
            const comment = commentInput.value;
            const dateVal = dateInput.value; // "2025-12-24T14:30" å½¢å¼

            if (!file && !comment) {
                alert("å†™çœŸã‹ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }
            if (!dateVal) {
                alert("æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            let imageData = null;
            if (file) {
                try {
                    imageData = await compressImage(file);
                } catch (e) {
                    alert("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    return;
                }
            }

            const newMemory = {
                id: Date.now(),
                timestamp: dateVal, // æ—¥æ™‚ã‚’ãã®ã¾ã¾ä¿å­˜
                image: imageData,
                comment: comment
            };

            const memories = getMemories();
            memories.push(newMemory);
            
            // ä¿å­˜ãƒ»ä¸¦ã³æ›¿ãˆãƒ»è¡¨ç¤º
            saveAndRender(memories);

            // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
            fileInput.value = "";
            commentInput.value = "";
            // æ—¥ä»˜ã¯ä»Šã®æ™‚é–“ã«ãƒªã‚»ãƒƒãƒˆã—ã¦ãŠã
            dateInput.value = getNowForInput();
            document.querySelector('.camera-icon').style.backgroundColor = 'transparent';
            document.querySelector('.camera-icon').style.color = '#ed6d3d';
        }

        // --- 2. è¡¨ç¤ºæ©Ÿèƒ½ï¼ˆè‡ªå‹•ã‚½ãƒ¼ãƒˆä»˜ãï¼‰ ---
        function loadMemories() {
            const memories = getMemories();
            renderMemories(memories);
        }

        function getMemories() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            return savedData ? JSON.parse(savedData) : [];
        }

        function saveAndRender(memories) {
            // â˜…é‡è¦ï¼šæ—¥ä»˜é †ï¼ˆå¤ã„é †ï¼‰ã«ä¸¦ã³æ›¿ãˆã‚‹
            memories.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(memories));
            } catch (e) {
                alert("å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚å¤ã„å†™çœŸã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚");
                return;
            }
            renderMemories(memories);
        }

        function renderMemories(memories) {
            const list = document.getElementById('memoryList');
            list.innerHTML = "";

            memories.forEach(item => {
                const div = document.createElement('div');
                div.className = 'memory-item';

                // æ—¥ä»˜ã®æ•´å½¢ (ä¾‹: 12/24 14:30)
                const dateObj = new Date(item.timestamp);
                const dateStr = `${dateObj.getMonth() + 1}/${dateObj.getDate()} ${String(dateObj.getHours()).padStart(2, '0')}:${String(dateObj.getMinutes()).padStart(2, '0')}`;

                let html = `
                    <div class="item-header">
                        <div class="time">${dateStr}</div>
                        <div class="actions">
                            <button class="action-btn edit-btn" onclick="openEditModal(${item.id})">âœï¸</button>
                            <button class="action-btn delete-btn" onclick="deleteMemory(${item.id})">Ã—</button>
                        </div>
                    </div>
                `;

                if (item.image) {
                    html += `<img src="${item.image}" class="photo">`;
                }
                if (item.comment) {
                    html += `<div class="comment">${escapeHtml(item.comment)}</div>`;
                }

                div.innerHTML = html;
                list.appendChild(div);
            });
            
            // æœ€æ–°ãŒè¦‹ãˆã‚‹ã‚ˆã†ã«ä¸€ç•ªä¸‹ã¸
            // window.scrollTo(0, document.body.scrollHeight); 
            // â†‘ç·¨é›†æ™‚ã«ã‚‚ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã‚Œã‚‹ã¨ã‚¦ã‚¶ã„ã®ã§ã€ä»Šå›ã¯è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã¯ã‚ªãƒ•ã«ã—ã¾ã™
        }

        // --- 3. ç·¨é›†æ©Ÿèƒ½ ---
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEditModal(id) {
            const memories = getMemories();
            const item = memories.find(m => m.id === id);
            if (!item) return;

            // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã«ä»Šã®å€¤ã‚’ã‚»ãƒƒãƒˆ
            document.getElementById('editId').value = item.id;
            document.getElementById('editDateInput').value = item.timestamp;
            document.getElementById('editCommentInput').value = item.comment;
            
            // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
            const preview = document.getElementById('editPreview');
            if (item.image) {
                preview.src = item.image;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }
            
            // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ã¯ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('editFileInput').value = "";

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
            document.getElementById('editModal').style.display = 'flex';
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // ç·¨é›†å†…å®¹ã‚’ä¿å­˜ï¼ˆæ›´æ–°ï¼‰
        async function saveEdit() {
            const id = Number(document.getElementById('editId').value);
            const dateVal = document.getElementById('editDateInput').value;
            const commentVal = document.getElementById('editCommentInput').value;
            const fileInput = document.getElementById('editFileInput');

            if (!dateVal) {
                alert("æ—¥æ™‚ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
                return;
            }

            const memories = getMemories();
            const index = memories.findIndex(m => m.id === id);
            if (index === -1) return;

            // æ–°ã—ã„ç”»åƒãŒé¸ã°ã‚Œã¦ã„ã‚Œã°åœ§ç¸®ã€ãªã‘ã‚Œã°å…ƒã®ç”»åƒã®ã¾ã¾
            let newImage = memories[index].image;
            if (fileInput.files && fileInput.files[0]) {
                try {
                    newImage = await compressImage(fileInput.files[0]);
                } catch (e) {
                    alert("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ");
                    return;
                }
            }

            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            memories[index].timestamp = dateVal;
            memories[index].comment = commentVal;
            memories[index].image = newImage;

            // ä¿å­˜ãƒ»ä¸¦ã³æ›¿ãˆï¼ˆæ—¥ä»˜ãŒå¤‰ã‚ã£ãŸå ´åˆç§»å‹•ã™ã‚‹ï¼‰ãƒ»å†è¡¨ç¤º
            saveAndRender(memories);
            closeModal();
        }

        // --- 4. å‰Šé™¤æ©Ÿèƒ½ ---
        function deleteMemory(id) {
            if (!confirm("æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            let memories = getMemories();
            memories = memories.filter(m => m.id !== id);
            saveAndRender(memories);
        }

        // --- ä¾¿åˆ©é–¢æ•° ---

        // input[type="datetime-local"] ç”¨ã«ç¾åœ¨æ™‚åˆ»ã‚’æ•´å½¢ã™ã‚‹ (YYYY-MM-DDTHH:mm)
        function getNowForInput() {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã«è£œæ­£
            return now.toISOString().slice(0, 16);
        }

        // ç”»åƒåœ§ç¸®é–¢æ•°
        function compressImage(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_SIZE = 800; // å°‘ã—ç”»è³ªå‘ä¸Š
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_SIZE) {
                                height *= MAX_SIZE / width;
                                width = MAX_SIZE;
                            }
                        } else {
                            if (height > MAX_SIZE) {
                                width *= MAX_SIZE / height;
                                height = MAX_SIZE;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        function escapeHtml(str) {
            if(!str) return "";
            return str.replace(/[&<>"']/g, function(match) {
                return {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                }[match];
            });
        }
    </script>
</body>
</html>